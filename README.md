# y-serve

`y-serve` is a standalone yjs server with batteries included:
- [x] Persistence to local disk, NFS, or S3-compatible blob storage (no database required!)
- [x] PASETO-based authorization system.
- [ ] Built-in debug interface.
- [ ] History API.

## Usage

### Install the server

    cargo install --path=y-serve

### Run a local server

You can run `y-serve` locally like this:

    y-serve serve ./data

This will use `./data` in the local directory as the document store and serve on localhost:8080.

### Enabling authentication

When authentication is enabled, all connections must be authenticated, whether they originate from your server or
the client.

Server connections are authenticated with a static bearer token. Client connections are authenticated with a token
generated by the server. (Technically, this is a [PASETO token](https://paseto.io/), but this is currently treated as
an implementation detail subject to change.)

The general authentication flow is:

- Client connects to your server to request access to a document.
- Your server checks the user's cookies to see if it is authorized to access the document in question.
- If it is, you call `getConnectionKey` on y-serve, authenticating the request with the “server token”.
- y-serve returns a `JSON`-serializable object containing connection information (server URL, access token, and document ID).
- Your server sends the conncetion key to the client.
- The client uses the connection key to connect directly to the document.

Client tokens are signed with a (symmetric) private key. To generate a new private key, run:

    y-serve gen-token

Then, run the server with:

    y-serve serve ./data --auth [result of gen-token]

`gen-token` will also print a **server token**. This should be passed as an HTTP bearer token on requests from your web server to
y-serve. If you are using our JavaScript API, this looks like:

```javascript
// The token is hard-coded for simplicity of the example. Use a secret manager in production!
const params = {"token": [your server token goes here]}
const docInfo = createDoc(params)
const connectionKey = getConnectionKey(docInfo['doc_id'], params)
```

The server token **should not be shared with the client**. Requests from the client instead use a **connection key**, which includes
a token scoped to a particular document.
